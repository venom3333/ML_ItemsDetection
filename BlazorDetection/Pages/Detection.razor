@page "/detection"

@using BlazorDetection.Data
@using System.IO
@using System.Diagnostics
@using System.Drawing;

@inject DetectionService DetectionService

<h3>Detection</h3>

<MatFileUpload OnChange="FileReady"></MatFileUpload>
@if (!string.IsNullOrWhiteSpace(errorMessage))
{
<textarea style="width: 100%; max-height: 300px; height: 300px;">@errorMessage</textarea>
}

@foreach (var image in imageStrings)
{
    <div>
        <img src="data:image/png;base64, @image"
             alt="Image"
             height="650"/>
    </div>
}

@code {

    string errorMessage;
    List<string> imageStrings = new List<string>();

    async Task FileReady(IMatFileUploadEntry[] files)
    {
        try
        {
            List<Bitmap> images = new List<Bitmap>();
            foreach (var file in files)
            {
                if (file == null)
                {
                    continue;
                }

                using (var stream = new MemoryStream())
                {
                    var sw = Stopwatch.StartNew();
                    await file.WriteToStreamAsync(stream);
                    sw.Stop();

                    Console.WriteLine($"Name:\t{file.Name}\r\n");
                    Console.WriteLine($"Type:\t{file.Type}\r\n");
                    Console.WriteLine($"LastModified:\t{file.LastModified}\r\n");
                    Console.WriteLine($"Size:\t{file.Size}\r\n");
                    Console.WriteLine($"Time:\t{sw.Elapsed}\r\n");
                    Console.WriteLine($"Speed:\t{(stream.Length / sw.Elapsed.TotalSeconds):N0}  b/s\r\n");

                    var image = Image.FromStream(stream);
                    var bitmap = new Bitmap(image);
                    images.Add(bitmap);
                }
            }
            imageStrings = await DetectionService.DetectAsync(images);
        }

        catch (Exception e)
        {
            errorMessage = $"Error:\r\n{e.Message}\r\n{e.StackTrace}";
        }
        finally
        {
            await InvokeAsync(async () => { this.StateHasChanged(); });
        }
    }

    protected override async Task OnInitializedAsync()
    {

    }
}
